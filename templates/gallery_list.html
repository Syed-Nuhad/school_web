{% extends "base.html" %}
{% block title %}Gallery{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.8.2/css/lightgallery-bundle.min.css">
{% endblock %}

{% block content %}
<section class="container py-5" id="gallery">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="fw-normal mb-0">Gallery</h1>
  </div>

  {% if page.object_list %}
    <div id="lightgallery" class="row g-3">

      {% for item in page.object_list %}
        <div class="col-12 col-sm-6 col-lg-3">
          <article class="card h-100 shadow-sm border-0 overflow-hidden gallery-card">

            {% if item.kind == "image" and item.image %}
              <a class="lg-trigger d-block position-relative"
                 href="javascript:void(0)"
                 data-src="{{ item.image.url }}"
                 data-sub-html="<h4 class='mb-0'>{{ item.title|escape }}</h4>"
                 data-download-url="{{ item.image.url }}"
                 data-lg-size="1600-1200">
                <div class="ratio ratio-16x9 glx-thumb">
                  <img src="{{ item.thumb_src|default:item.image.url }}" alt="{{ item.title }}"
                       class="w-100 h-100 object-fit-cover" loading="lazy">
                </div>
                <span class="glx-chip"><i class="bi bi-image"></i></span>
              </a>

            {% elif item.kind == "video" and item.video %}
              <a class="lg-trigger d-block position-relative"
                 href="javascript:void(0)"
                 data-src="{{ item.video.url }}"
                 data-sub-html="<h4 class='mb-0'>{{ item.title|escape }}</h4>"
                 data-download-url="{{ item.video.url }}"
                 data-lg-size="1280-720"
                 data-video='{
                   "source":[{ "src":"{{ item.video.url|escapejs }}", "type":"video/mp4" }],
                   "attributes":{ "preload":"metadata", "controls": true, "playsinline": true }
                 }'>
                <div class="ratio ratio-16x9 glx-thumb">
                  {% if item.thumb_src %}
                    <img src="{{ item.thumb_src }}" alt="{{ item.title }}" class="w-100 h-100 object-fit-cover" loading="lazy">
                  {% else %}
                    <div class="w-100 h-100 bg-dark d-flex align-items-center justify-content-center text-white">
                      <i class="bi bi-play-circle-fill" style="font-size:2.2rem;"></i>
                    </div>
                  {% endif %}
                </div>
                <span class="glx-chip"><i class="bi bi-film"></i></span>
              </a>

            {% elif item.kind == "youtube" and item.youtube_id %}
              <a class="yt-trigger d-block position-relative"
                 href="javascript:void(0)"
                 data-yt-id="{{ item.youtube_id }}"
                 data-yt-title="{{ item.title|escape }}">
                <div class="ratio ratio-16x9 glx-thumb">
                  <img src="https://img.youtube.com/vi/{{ item.youtube_id }}/hqdefault.jpg"
                       alt="{{ item.title }}" class="w-100 h-100 object-fit-cover" loading="lazy">
                </div>
                <span class="glx-chip"><i class="bi bi-youtube"></i></span>
              </a>

            {% else %}
              <div class="ratio ratio-16x9 bg-light d-flex align-items-center justify-content-center text-muted">
                No media
              </div>
            {% endif %}

            <div class="p-2">
              <h6 class="mb-0 text-truncate" title="{{ item.title }}">{{ item.title }}</h6>
            </div>
          </article>
        </div>
      {% endfor %}
    </div>

    {% if page.paginator.num_pages > 1 %}
      <nav class="mt-4" aria-label="Gallery pagination">
        <ul class="pagination justify-content-center">
          {% if page.has_previous %}
            <li class="page-item"><a class="page-link" href="?page={{ page.previous_page_number }}#gallery">← Prev</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">← Prev</span></li>
          {% endif %}

          {% for p in page.paginator.page_range %}
            {% if p >= page.number|add:-1 and p <= page.number|add:1 %}
              {% if p == page.number %}
                <li class="page-item active"><span class="page-link">{{ p }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="?page={{ p }}#gallery">{{ p }}</a></li>
              {% endif %}
            {% endif %}
          {% endfor %}

          {% if page.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page.next_page_number }}#gallery">Next →</a></li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Next →</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  {% else %}
    <div class="alert alert-info mb-0">No gallery items yet.</div>
  {% endif %}
</section>

{# YouTube Modal (fullscreen) #}
<div class="modal fade" id="ytModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content bg-black text-white">
      <div class="modal-body p-0 position-relative">
        <div class="yt-stage position-absolute top-0 bottom-0 start-0 end-0 d-flex align-items-center justify-content-center">
          <div class="yt-box">
            <div id="ytPlayerMount"></div>
          </div>
        </div>

        <button type="button" class="btn-nav yt-prev" aria-label="Previous">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button type="button" class="btn-nav yt-next" aria-label="Next">
          <i class="bi bi-chevron-right"></i>
        </button>

        <button type="button" class="btn-close btn-close-white position-absolute"
                style="right:18px; top:18px" data-bs-dismiss="modal" aria-label="Close"></button>

        <div id="ytCaption" class="position-absolute start-0 end-0 text-center small text-white-50"
             style="bottom:.75rem;"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_body %}
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.8.2/lightgallery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.8.2/plugins/zoom/lg-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.8.2/plugins/thumbnail/lg-thumbnail.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.8.2/plugins/fullscreen/lg-fullscreen.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.8.2/plugins/video/lg-video.min.js"></script>

<script>
  // Prevent default nav for LG triggers
  document.addEventListener('click', e => {
    const a = e.target.closest('a.lg-trigger');
    if (a) e.preventDefault();
  });

  // Build mixed index (LG + YT) in DOM order
  let ytPlayer=null, allIndex=0;
  let ytTriggers=[], lgTriggers=[], allItems=[];

  function buildIndex(){
    ytTriggers = Array.from(document.querySelectorAll('.yt-trigger'));
    lgTriggers = Array.from(document.querySelectorAll('.lg-trigger'));
    allItems = [];

    document.querySelectorAll('#lightgallery .gallery-card').forEach(card=>{
      const link = card.querySelector('a.yt-trigger, a.lg-trigger');
      if(!link) return;
      if(link.classList.contains('yt-trigger')){
        link.dataset.allIndex = allItems.length;
        allItems.push({type:'yt', idx: ytTriggers.indexOf(link)});
      }else{
        link.dataset.allIndex = allItems.length;
        allItems.push({type:'lg', idx: lgTriggers.indexOf(link)});
      }
    });
  }
  buildIndex();

  // Init LightGallery
  const gridEl = document.getElementById('lightgallery');
  const lgInstance = lightGallery(gridEl, {
    selector: '.lg-trigger',
    plugins: [lgZoom, lgThumbnail, lgFullscreen, lgVideo],
    loop: true,
    download: true,
    speed: 350,
    hash: false,
    autoplayFirstVideo: false
  });

  // Track mixed index when an LG card is clicked
  document.addEventListener('click', e=>{
    const a = e.target.closest('.lg-trigger');
    if(!a) return;
    allIndex = parseInt(a.dataset.allIndex || '0', 10);
  });

  // SAFE bridge: only hop to YT when valid & never block LG if anything is odd
  gridEl.addEventListener('lgBeforeSlide', (evt)=>{
    try {
      const detail = evt.detail || {};
      if (!Number.isInteger(detail.prevIndex) || !Number.isInteger(detail.index)) return;
      const prevIdx = detail.prevIndex;
      const nextIdx = detail.index;

      if (!lgTriggers[prevIdx] || !lgTriggers[nextIdx]) return;

      const prevAll = parseInt(lgTriggers[prevIdx].dataset.allIndex);
      const nextAll = parseInt(lgTriggers[nextIdx].dataset.allIndex);
      if (isNaN(prevAll) || isNaN(nextAll)) { allIndex = nextAll; return; }

      const step = nextAll > prevAll ? 1 : -1;
      let hop = prevAll + step;

      // If there is a YT item between those mixed positions, hop to it AFTER LG processes
      while (hop !== nextAll + step) {
        if (allItems[hop] && allItems[hop].type === 'yt') {
          setTimeout(() => { // queue to avoid interfering with LG internals
            try { lgInstance.closeGallery(); } catch(_) {}
            openByAllIndex(hop);
          }, 0);
          return;
        }
        hop += step;
      }
      allIndex = nextAll;
    } catch (e) {
      // fail-open: never block LG navigation
    }
  });

  // YouTube IFrame API
  (function(){
    const s=document.createElement('script'); s.src="https://www.youtube.com/iframe_api";
    document.head.appendChild(s);
  })();

  window.onYouTubeIframeAPIReady = function(){
    ytPlayer = new YT.Player('ytPlayerMount', {
      width:'100%', height:'100%', videoId:'',
      playerVars:{ origin:window.location.origin, rel:0, modestbranding:1, playsinline:1, controls:1 },
      events:{
        onError: function(){
          const cap = document.getElementById('ytCaption');
          const rec = allItems[allIndex];
          if(cap && rec && rec.type==='yt'){
            const id = ytTriggers[rec.idx].getAttribute('data-yt-id');
            cap.innerHTML = 'Video unavailable. '+
              '<a class="link-light text-decoration-underline" target="_blank" rel="noopener" href="https://www.youtube.com/watch?v='+encodeURIComponent(id)+'">Watch on YouTube</a>';
          }
        }
      }
    });
  };

  function showYouTubeByIndex(mixedIdx){
    allIndex = (mixedIdx + allItems.length) % allItems.length;
    const rec = allItems[allIndex];
    if(!rec || rec.type!=='yt') return;

    const a   = ytTriggers[rec.idx];
    const id  = a.getAttribute('data-yt-id');
    const ttl = a.getAttribute('data-yt-title') || '';
    const cap = document.getElementById('ytCaption');
    if(cap) cap.textContent = ttl;

    const modalEl = document.getElementById('ytModal');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();

    (function cue(){
      if(ytPlayer && ytPlayer.loadVideoById){ ytPlayer.loadVideoById(id); }
      else { setTimeout(cue, 80); }
    })();
  }

  function openByAllIndex(mixedIdx){
    allIndex = (mixedIdx + allItems.length) % allItems.length;
    const rec = allItems[allIndex];
    if(rec.type === 'yt'){
      try { lgInstance.closeGallery(); } catch(_) {}
      showYouTubeByIndex(allIndex);
    }else{
      const mEl = document.getElementById('ytModal');
      bootstrap.Modal.getOrCreateInstance(mEl).hide();
      if (ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();
      lgInstance.openGallery(rec.idx);
    }
  }

  // Click YT card → open unified modal flow
  document.addEventListener('click', e=>{
    const a = e.target.closest('.yt-trigger');
    if(!a) return;
    e.preventDefault();
    openByAllIndex(parseInt(a.dataset.allIndex || '0', 10));
  });

  // YT modal Prev/Next → unified flow
  document.querySelector('#ytModal .yt-prev').addEventListener('click', ()=> openByAllIndex(allIndex - 1));
  document.querySelector('#ytModal .yt-next').addEventListener('click', ()=> openByAllIndex(allIndex + 1));

  // Stop YT when closing
  document.getElementById('ytModal').addEventListener('hidden.bs.modal', ()=> {
    if (ytPlayer && ytPlayer.stopVideo) ytPlayer.stopVideo();
  });

  // Rebuild mapping after navigation/pagination
  window.addEventListener('pageshow', buildIndex);
</script>

<style>
  /* Cards & thumbs */
  .glx-thumb{ border-radius:.5rem .5rem 0 0; overflow:hidden; }
  .object-fit-cover{ object-fit:cover; }
  .gallery-card{ transition:transform .15s ease, box-shadow .15s ease; }
  .gallery-card:hover{ transform:translateY(-3px); box-shadow:0 .75rem 1.25rem rgba(0,0,0,.08); }
  .glx-chip{
    position:absolute; left:.6rem; bottom:.6rem;
    display:inline-flex; align-items:center; justify-content:center;
    width:28px; height:28px; border-radius:8px;
    background:rgba(0,0,0,.6); color:#fff; font-size:.95rem;
    border:1px solid rgba(255,255,255,.2); backdrop-filter:blur(2px);
    pointer-events:none;
  }

  /* Unify nav buttons for LG & YT */

  /* LightGallery arrows – always visible and clickable */
  .lg-outer .lg-prev, .lg-outer .lg-next{
    opacity:1 !important; visibility:visible !important; pointer-events:auto !important;
    width:44px; height:44px; border-radius:999px;
    background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.25);
    backdrop-filter: blur(2px);
    top:50%; transform:translateY(-50%);
    z-index: 9999;
    display:flex; align-items:center; justify-content:center;
  }
  .lg-outer .lg-prev{ left:24px; }
  .lg-outer .lg-next{ right:24px; }

  /* Hide default arrow glyph and use Bootstrap Icons */
  .lg-outer .lg-prev:after, .lg-outer .lg-next:after{ display:none; }
  .lg-outer .lg-prev::before, .lg-outer .lg-next::before{
    font-family:"bootstrap-icons"; font-size:22px; line-height:1; color:#fff; content:'';
  }
  .lg-outer .lg-prev::before{ content:"\F284"; } /* chevron-left */
  .lg-outer .lg-next::before{ content:"\F285"; } /* chevron-right */

  /* YT stage & arrows (same look/placement) */
  #ytModal .yt-stage{ background:#000; }
  #ytModal .yt-box{
    width: min(96vw, calc(96vh * 16 / 9));
    aspect-ratio:16/9;
  }
  #ytModal iframe, #ytPlayerMount{ width:100%; height:100%; }

  .btn-nav{
    position:absolute; top:50%; transform:translateY(-50%);
    width:44px; height:44px; border-radius:999px;
    border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.10); color:#fff;
    display:flex; align-items:center; justify-content:center;
    z-index:1065;
  }
  .btn-nav i{ font-size:22px; line-height:1; }
  .btn-nav.yt-prev{ left:24px; }
  .btn-nav.yt-next{ right:24px; }
</style>
{% endblock %}
