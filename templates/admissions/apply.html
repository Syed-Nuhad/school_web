{# templates/admissions/apply.html #}
{% extends "base.html" %}
{% load static humanize %}

{% block title %}Apply for Admission{% endblock %}

{% block content %}
<section class="py-5 bg-light" id="admission-form">
  <div class="container">
    <div class="row g-4">

      <!-- Tips (sticky on large screens) -->
      <aside class="col-lg-4 order-lg-2">
        <div class="card border-0 shadow-sm" style="position:sticky; top:1rem">
          <div class="card-body">
            <h5 class="fw-semibold mb-3">Tips</h5>
            <ul class="list-group list-group-flush small">
              <li class="list-group-item px-0">Use a valid email and phone number.</li>
              <li class="list-group-item px-0">If you came from a course card, it’s pre-selected below.</li>
              <li class="list-group-item px-0">Upload only PDF / JPG / PNG files.</li>
            </ul>
          </div>
        </div>
      </aside>

      <!-- Form -->
      <div class="col-lg-8 order-lg-1">
        <div class="card shadow border-0 rounded-4">
          <div class="card-body p-4 p-md-5">

            {% if selected_course %}
              <div class="alert alert-light border d-flex align-items-center gap-3 mb-4">
                {% if selected_course.image %}
                  <img src="{{ selected_course.image.url }}" alt="" class="rounded border" style="width:48px;height:48px;object-fit:cover">
                {% endif %}
                <div class="flex-grow-1">
                  <div class="fw-semibold">{{ selected_course.title }}</div>
                  <div class="small text-muted text-uppercase">{{ selected_course.get_category_display }}</div>
                </div>
                <a href="{% url 'home' %}#academics" class="btn btn-sm btn-outline-secondary">Change</a>
              </div>
            {% endif %}

            {% if form.non_field_errors %}
              <div class="alert alert-danger mb-4">
                {{ form.non_field_errors }}
              </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" novalidate>
              {% csrf_token %}

              {# Keep the course fixed if preselected #}
              {% if selected_course and form.desired_course %}
                {{ form.desired_course.as_hidden }}
              {% endif %}

              <!-- SECTION: Student info -->
              <h5 class="mb-3">Student Information</h5>

              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ form.full_name.id_for_label }}">
                    {{ form.full_name.label }}{% if form.full_name.field.required %} <span class="text-danger">*</span>{% endif %}
                  </label>
                  {{ form.full_name }}
                  {% if form.full_name.errors %}<div class="invalid-feedback d-block">{{ form.full_name.errors|striptags }}</div>{% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
                  {{ form.email }}
                  {% if form.email.errors %}<div class="invalid-feedback d-block">{{ form.email.errors|striptags }}</div>{% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ form.phone.id_for_label }}">
                    {{ form.phone.label }}{% if form.phone.field.required %} <span class="text-danger">*</span>{% endif %}
                  </label>
                  {{ form.phone }}
                  <div class="form-text">Format: 01XXXXXXXXX</div>
                  {% if form.phone.errors %}<div class="invalid-feedback d-block">{{ form.phone.errors|striptags }}</div>{% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ form.date_of_birth.id_for_label }}">{{ form.date_of_birth.label }}</label>
                  {{ form.date_of_birth }}
                  {% if form.date_of_birth.errors %}<div class="invalid-feedback d-block">{{ form.date_of_birth.errors|striptags }}</div>{% endif %}
                </div>

                <div class="col-12">
                  <label class="form-label fw-semibold" for="{{ form.address.id_for_label }}">{{ form.address.label }}</label>
                  {{ form.address }}
                  {% if form.address.errors %}<div class="invalid-feedback d-block">{{ form.address.errors|striptags }}</div>{% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ form.guardian_name.id_for_label }}">{{ form.guardian_name.label }}</label>
                  {{ form.guardian_name }}
                  {% if form.guardian_name.errors %}<div class="invalid-feedback d-block">{{ form.guardian_name.errors|striptags }}</div>{% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ form.guardian_phone.id_for_label }}">{{ form.guardian_phone.label }}</label>
                  {{ form.guardian_phone }}
                  {% if form.guardian_phone.errors %}<div class="invalid-feedback d-block">{{ form.guardian_phone.errors|striptags }}</div>{% endif %}
                </div>

                {% if not selected_course %}
                  <div class="col-md-6">
                    <label class="form-label fw-semibold" for="{{ form.desired_course.id_for_label }}">{{ form.desired_course.label }}</label>
                    {{ form.desired_course }}
                    {% if form.desired_course.help_text %}<div class="form-text">{{ form.desired_course.help_text|safe }}</div>{% endif %}
                    {% if form.desired_course.errors %}<div class="invalid-feedback d-block">{{ form.desired_course.errors|striptags }}</div>{% endif %}
                  </div>
                {% endif %}

                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ form.shift.id_for_label }}">{{ form.shift.label }}</label>
                  {{ form.shift }}
                  {% if form.shift.errors %}<div class="invalid-feedback d-block">{{ form.shift.errors|striptags }}</div>{% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ form.previous_school.id_for_label }}">{{ form.previous_school.label }}</label>
                  {{ form.previous_school }}
                  {% if form.previous_school.errors %}<div class="invalid-feedback d-block">{{ form.previous_school.errors|striptags }}</div>{% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ form.ssc_gpa.id_for_label }}">{{ form.ssc_gpa.label }}</label>
                  {{ form.ssc_gpa }}
                  <div class="form-text">Max 5.00</div>
                  {% if form.ssc_gpa.errors %}<div class="invalid-feedback d-block">{{ form.ssc_gpa.errors|striptags }}</div>{% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ form.photo.id_for_label }}">{{ form.photo.label }}</label>
                  {{ form.photo }}
                  <div class="form-text">JPG/PNG up to 5&nbsp;MB.</div>
                  {% if form.photo.errors %}<div class="invalid-feedback d-block">{{ form.photo.errors|striptags }}</div>{% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label fw-semibold" for="{{ form.transcript.id_for_label }}">{{ form.transcript.label }}</label>
                  {{ form.transcript }}
                  <div class="form-text">PDF/JPG/PNG up to 10&nbsp;MB.</div>
                  {% if form.transcript.help_text %}<div class="form-text">{{ form.transcript.help_text|safe }}</div>{% endif %}
                  {% if form.transcript.errors %}<div class="invalid-feedback d-block">{{ form.transcript.errors|striptags }}</div>{% endif %}
                </div>

                <div class="col-12">
                  <label class="form-label fw-semibold" for="{{ form.message.id_for_label }}">{{ form.message.label }}</label>
                  {{ form.message }}
                  <div class="form-text">Optional</div>
                  {% if form.message.errors %}<div class="invalid-feedback d-block">{{ form.message.errors|striptags }}</div>{% endif %}
                </div>
              </div>

              <!-- Fees (server-calculated preview) -->
              <hr class="my-4">
              <h5 class="mb-3">Fee Breakdown</h5>

              {% with fb=fee_breakdown %}
              <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle mb-3">
                  <caption class="text-muted small">Amounts shown in BDT</caption>
                  <tbody>
                    <tr>
                      <th class="w-50">Admission Fee</th>
                      <td class="text-end">৳ {{ fb.admission|default:0|floatformat:0|intcomma }}</td>
                    </tr>
                    <tr>
                      <th>Tuition Fee (1st month)</th>
                      <td class="text-end">৳ {{ fb.tuition|default:0|floatformat:0|intcomma }}</td>
                    </tr>
                    <tr>
                      <th>Exam Fee</th>
                      <td class="text-end">৳ {{ fb.exam|default:0|floatformat:0|intcomma }}</td>
                    </tr>
                    <tr>
                      <th>Bus Service</th>
                      <td class="text-end">৳ {{ fb.bus|default:0|floatformat:0|intcomma }}</td>
                    </tr>
                    <tr>
                      <th>Hostel Seat</th>
                      <td class="text-end">৳ {{ fb.hostel|default:0|floatformat:0|intcomma }}</td>
                    </tr>
                    <tr>
                      <th>Exact Marksheet</th>
                      <td class="text-end">৳ {{ fb.marksheet|default:0|floatformat:0|intcomma }}</td>
                    </tr>
                    <tr class="table-active">
                      <th>Total</th>
                      <td class="fw-bold text-end">৳ {{ fb.total|default:0|floatformat:0|intcomma }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              {% endwith %}

              <!-- Add-ons (real form fields; server will snapshot on POST) -->
              <div class="row g-2 mb-3">
                <div class="col-12 col-sm-4">
                  <div class="form-check">
                    {{ form.add_bus }} <label class="form-check-label" for="{{ form.add_bus.id_for_label }}">Add School Bus</label>
                  </div>
                </div>
                <div class="col-12 col-sm-4">
                  <div class="form-check">
                    {{ form.add_hostel }} <label class="form-check-label" for="{{ form.add_hostel.id_for_label }}">Add Hostel Seat</label>
                  </div>
                </div>
                <div class="col-12 col-sm-4">
                  <div class="form-check">
                    {{ form.add_marksheet }} <label class="form-check-label" for="{{ form.add_marksheet.id_for_label }}">Add Exact Marksheet</label>
                  </div>
                </div>
              </div>

              <!-- Note: Payment happens on the Review page after submit -->
              <div class="alert alert-info small mb-0">
                After you submit, you’ll see a final review with the exact total and payment options.
              </div>

              <!-- Actions -->
              <div class="d-flex flex-wrap gap-3 justify-content-center mt-4">
                <button type="submit" class="btn btn-primary px-4 py-2">Submit &amp; Review</button>
                <a href="{% url 'home' %}" class="btn btn-outline-secondary px-4 py-2">Cancel</a>
              </div>

            </form>

          </div>
        </div>
      </div>

    </div>
  </div>
</section>
{% endblock %}
