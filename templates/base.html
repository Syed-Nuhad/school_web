<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}College Management System{% endblock %}</title>
  <!-- Custom CSS files -->
  <link rel="stylesheet" href="{% static 'css/cms.css' %}" />
  <link rel="stylesheet" href="{% static 'style.css' %}" />
  <!-- Bootstrap 5 CSS (unified to one version) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Bootstrap Icons (for any icon usage) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Font Awesome (one copy, latest) -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/css/lightgallery-bundle.min.css">

  <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/lightgallery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/zoom/lg-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/download/lg-download.min.js"></script>


  <!-- AOS CSS (Animate On Scroll library) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.css" />


</head>
<body>
  {% include "partials/navbar.html" %}

  <!-- Main page content -->
  {% block content %}{% endblock %}

  {% include "partials/footer.html" %}
<!-- Bootstrap 5 (bundle) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

<!-- AOS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js" defer></script>

<!-- LightGallery (CSS + JS + plugins) — REQUIRED for the syllabus image modal -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/css/lightgallery-bundle.min.css">
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/lightgallery.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/zoom/lg-zoom.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.2/plugins/download/lg-download.min.js" defer></script>

<!-- jsPDF (only if you still generate PDFs like marksheets) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>if (window.jspdf && window.jspdf.jsPDF) { window.jsPDF = window.jspdf.jsPDF; }</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<!-- Your scripts (defer to keep order after libraries) -->
<script src="{% static 'js/common.js' %}" defer></script>
<script src="{% static 'js/fees.js' %}" defer></script>
<script src="{% static 'script.js' %}" defer></script>
  <script>document.addEventListener('DOMContentLoaded', () => AOS.init());</script>
<script src="https://www.paypal.com/sdk/js?client-id=AXcoTkzjuLBB9DiaFF5H5-4OXtdoPHiZ2LhdWq0PPqt9_ZVJHhaFpIQY9rCwpeKMNU1af8op8TVfWnxV&currency=USD&components=buttons,funding-eligibility&enable-funding=card" defer></script>

<script>
/* Wrap everything to avoid polluting globals and to dodge $ collisions */
(function () {
  const $id = (s) => document.getElementById(s);
  const setStatus = (type, msg) => {
    const el = $id('payment-status'); if (!el) return;
    el.className = `alert alert-${type} py-2 mt-3 mb-0`;
    el.textContent = msg;
  };
  const unlock = () => {
    $id('submit-btn')?.removeAttribute('disabled');
    $id('print-btn')?.removeAttribute('disabled');
    setStatus('success', 'Payment confirmed ✅');
  };

  // --- bKash button (redirects to your backend-init URL) ---
  const bkBtn = $id('bkash-btn');
  bkBtn && bkBtn.addEventListener('click', async () => {
    try {
      setStatus('secondary', 'Starting bKash…');
      const r = await fetch('/pay/bkash/init/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ amount: 1500 })
      });
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || 'Init failed');
      location.href = j.bkash_url;
    } catch (e) {
      setStatus('danger', e.message || 'Could not start bKash.');
    }
  });

  // --- PayPal mount: wallet + card-only button ---
  function mountPayPal(attempt = 1) {
    if (!window.paypal) {
      if (attempt < 30) return setTimeout(() => mountPayPal(attempt + 1), 150); // wait up to ~4.5s
      return setStatus('danger', 'PayPal SDK not loaded. Check client-id/CSP.');
    }
    try {
      // 1) Wallet button (normal PayPal)
      paypal.Buttons({
        style: { layout: 'horizontal', shape: 'pill', height: 45 },
        // client-side demo create/capture; swap to server calls when ready
        createOrder: (data, actions) => actions.order.create({
          purchase_units: [{ amount: { value: '15.00' } }]
        }),
        onApprove: (data, actions) => actions.order.capture().then(unlock),
        onError: (err) => setStatus('danger', 'PayPal error: ' + (err?.message || err))
      }).render('#paypal-button-container');

      // 2) Card-only button (Debit or Credit Card)
      const cardBtn = paypal.Buttons({
        fundingSource: paypal.FUNDING.CARD,
        style: { layout: 'horizontal', shape: 'pill', height: 45 },
        createOrder: (data, actions) => actions.order.create({
          purchase_units: [{ amount: { value: '15.00' } }]
        }),
        onApprove: (data, actions) => actions.order.capture().then(unlock),
        onError: (err) => setStatus('danger', 'Card payment error: ' + (err?.message || err))
      });

      if (cardBtn.isEligible()) {
        cardBtn.render('#paypal-card-button');
      } else {
        // Not eligible → account/region/currency setting
        const s = $id('payment-status');
        if (s) { s.className = 'alert alert-info py-2 mt-3 mb-0'; s.textContent = 'Card button not eligible for this client/country/currency.'; }
      }
    } catch (e) {
      console.error(e);
      setStatus('danger', 'PayPal init exception. See console.');
    }
  }

  // mount after window load (SDK is defer-loaded)
  window.addEventListener('load', mountPayPal);

  // If coming back from a provider with ?paid=1
  const q = new URLSearchParams(location.search);
  if (q.get('paid') === '1') unlock();
})();
</script>
</body>
</html>