{% extends "base.html" %}
{% load static %}

{% block title %}Class Attendance — {{ klass.name }}{% if klass.section %} – {{ klass.section }}{% endif %}{% endblock %}

{% block extra_head %}{% endblock %}

{% block content %}
<section class="container-xxl py-4 py-md-5"
         id="att-root"
         data-class-id="{{ klass.id }}"
         data-url-day="{% url 'attendance_classday_get' 0 %}">

  <!-- Single, simple summary card -->
  <div class="card shadow-sm">
    <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-3">

      <!-- Class title + date -->
      <div>
        <h1 class="h5 mb-1">
          {{ klass.name }}{% if klass.section %} – {{ klass.section }}{% endif %}
          <span class="text-muted fw-normal">({{ klass.year }})</span>
        </h1>
        <div class="text-muted small">Date: <span id="attDate">—</span></div>
      </div>

      <!-- Counts row (big, readable) -->
      <div class="d-flex flex-wrap align-items-center gap-3">
        <div class="text-center">
          <div class="small text-muted">Present</div>
          <div class="h4 mb-0" id="present">0</div>
        </div>
        <div class="text-center">
          <div class="small text-muted">Absent</div>
          <div class="h4 mb-0" id="absent">0</div>
        </div>
        <div class="text-center">
          <div class="small text-muted">Late</div>
          <div class="h4 mb-0" id="late">0</div>
        </div>
        <div class="text-center">
          <div class="small text-muted">Excused</div>
          <div class="h4 mb-0" id="excused">0</div>
        </div>
        <div class="text-center">
          <div class="small text-muted">Total</div>
          <div class="h4 mb-0" id="total">0</div>
        </div>
        <div class="text-center">
          <div class="small text-muted">Rate</div>
          <div class="h4 mb-0"><span id="rate">0.0</span>%</div>
        </div>
      </div>

    </div>
  </div>

</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const root = document.getElementById("att-root");
  const classId = Number(root.dataset.classId);
  const urlDayTpl = root.dataset.urlDay; // ends with /0/

  // Build the day endpoint URL for a specific date
  const urlDay = (cid, dateStr) => {
    const base = urlDayTpl.replace(/0\/?$/, cid.toString() + "/");
    return base + (dateStr ? ("?date=" + encodeURIComponent(dateStr)) : "");
  };

  // Elements
  const el = (id) => document.getElementById(id);
  const eDate = el("attDate"), eP = el("present"), eA = el("absent"),
        eL = el("late"), eE = el("excused"), eT = el("total"), eR = el("rate");

  // Today in YYYY-MM-DD
  const today = new Date();
  const todayStr = today.toISOString().slice(0,10);

  // Load today's counts and show them
  (async () => {
    eDate.textContent = todayStr;
    try {
      const resp = await fetch(urlDay(classId, todayStr));
      if (!resp.ok) throw new Error("Failed");
      const j = await resp.json();

      // If nothing saved for today, backend returns zeros — perfect.
      eP.textContent = (j.present ?? 0);
      eA.textContent = (j.absent ?? 0);
      eL.textContent = (j.late ?? 0);
      eE.textContent = (j.excused ?? 0);
      eT.textContent = (j.total ?? 0);
      eR.textContent = (j.rate_pct ?? 0).toFixed(1);
    } catch (err) {
      // Leave zeros; show date anyway
      console.error(err);
    }
  })();
});
</script>
{% endblock %}
