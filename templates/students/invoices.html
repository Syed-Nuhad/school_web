{% extends "base.html" %}
{% load humanize %}

{% block title %}My Invoices{% endblock %}

{% block content %}
<section class="py-4">
  <div class="container">

    <!-- Header -->
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
      <div>
        <h3 class="mb-1">My Invoices</h3>
        <div class="text-muted">Review your monthly tuition and any custom fees.</div>
      </div>

      <!-- Pay ALL (Stripe) -->
      <form method="post" action="{% url 'content:invoice-bulk-checkout-all' %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary"
                {% if not summary or summary.total_due|floatformat:2 == '0.00' %}disabled{% endif %}>
          Pay all dues
          {% if summary and summary.total_due and summary.total_due > 0 %}
            (৳ {{ summary.total_due|floatformat:0|intcomma }})
          {% endif %}
        </button>
      </form>
    </div>

    <!-- Banner -->
    {% if summary and summary.upcoming %}
      <div class="alert alert-secondary py-2 px-3 mb-4">
        Upcoming month ready:
        <strong>{{ summary.upcoming.period_year }}-{{ summary.upcoming.period_month|stringformat:"02d" }}</strong>.
        You can pay dues anytime.
      </div>
    {% endif %}

    <!-- Top stats -->
    <div class="row g-3 mb-3">
      <div class="col-12 col-md-4">
        <div class="invoice-card p-3">
          <div class="text-muted small">Total due</div>
          <div class="fs-4 fw-semibold">৳ {{ summary.total_due|default:0|floatformat:2|intcomma }}</div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="invoice-card p-3">
          <div class="text-muted small">Next month</div>
          <div class="fs-6">
            {% if summary and summary.upcoming %}
              {{ summary.upcoming.period_year }}-{{ summary.upcoming.period_month|stringformat:"02d" }}
            {% else %}
              —
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4">
        <div class="invoice-card p-3 d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted small">Quick actions</div>
            <div class="small">Select invoices below & pay selected</div>
          </div>
          <button id="pay-selected-btn" class="btn btn-primary btn-sm" disabled>Pay selected</button>
        </div>
      </div>
    </div>

    {% if invoices %}
      <div class="invoice-card">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:36px"><input class="form-check-input" type="checkbox" id="toggle-all"></th>
                <th scope="col" class="text-center">Type</th>
                <th scope="col" class="hide-sm text-center">Year</th>
                <th scope="col" class="text-center">Month / Title</th>
                <th scope="col" class="text-end">Amount</th>
                <th scope="col" class="text-end hide-sm">Paid</th>
                <th scope="col" class="text-end">Balance</th>
                <th scope="col" class="text-end">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for inv in invoices %}
                {% with db=inv.balance|default:0 %}
                <tr class="{% if db > 0 %}row-overdue{% endif %}">
                  <td>
                    {% if db > 0 %}
                      <input class="form-check-input row-check" value="{{ inv.id }}" type="checkbox">
                    {% endif %}
                  </td>
                  <td class="text-center">
                    {% if inv.kind == 'monthly' %}
                      <h6><span class="badge text-bg-primary">Monthly</span></h6>
                    {% else %}
                      <h6><span class="badge text-bg-light">Custom</span></h6>
                    {% endif %}
                  </td>
                  <td class="hide-sm text-center">
                    {% if inv.kind == 'monthly' %}{{ inv.period_year }}{% else %}—{% endif %}
                  </td>
                  <td class="text-center">
                    {% if inv.kind == 'monthly' %}
                      {{ inv.period_month|stringformat:"02d" }}
                    {% else %}
                      {{ inv.title|default:"—" }}
                    {% endif %}
                  </td>
                  <td class="text-end">৳ {{ inv.tuition_amount|default:0|floatformat:2|intcomma }}</td>

                  {# ==== Paid (capped at Amount) ==== #}
                  <td class="text-end hide-sm">
                    {% with amt=inv.tuition_amount|default:0 paid=inv.paid_amount|default:0 %}
                      ৳ {% if paid > amt %}{{ amt|floatformat:2|intcomma }}{% else %}{{ paid|floatformat:2|intcomma }}{% endif %}
                    {% endwith %}
                  </td>

                  {# Balance display #}
                  <td class="text-end">
                    {% if db > 0 %}
                      <span class="chip chip-due">৳ {{ db|floatformat:2|intcomma }}</span>
                    {% else %}
                      <span class="chip chip-paid">৳ 0.00</span>
                    {% endif %}
                  </td>

                  <td class="text-end">
                    {% if db > 0 %}
                      <a class="btn btn-sm btn-outline-primary" href="{% url 'content:invoice-pay' inv.id %}">Pay now</a>
                    {% else %}
                      <h6><span class="badge text-bg-success">Paid</span></h6>
                    {% endif %}
                  </td>
                </tr>
                {% endwith %}
              {% endfor %}
            </tbody>

            {% if summary %}
              <tfoot class="table-light">
                <tr>
                  <th colspan="6" class="text-end">Total due</th>
                  <th class="text-end">৳ {{ summary.total_due|default:0|floatformat:2|intcomma }}</th>
                  <th class="text-end">
                    <form method="post" action="{% url 'content:invoice-bulk-checkout-all' %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-primary"
                              {% if summary.total_due|floatformat:2 == '0.00' %}disabled{% endif %}>
                        Pay all
                      </button>
                    </form>
                  </th>
                </tr>
              </tfoot>
            {% endif %}
          </table>
        </div>
      </div>
    {% else %}
      <div class="invoice-card p-4">
        <p class="mb-0 text-muted">No invoices yet.</p>
      </div>
    {% endif %}

    {# ===================== START: My Payments (Receipts) ===================== #}
    <div class="mt-4">
      <h5 class="mb-3">My Payments</h5>

      {% if payments %}
        <div class="invoice-card">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">Payment #</th>
                  <th scope="col">Gateway</th>
                  <th scope="col" class="d-none d-md-table-cell">Reference</th>
                  <th scope="col" class="text-end">Amount</th>
                  <th scope="col" class="text-end">Paid at</th>
                  <th scope="col" class="text-end">Receipt</th>
                </tr>
              </thead>
              <tbody>
                {% for p in payments %}
                  <tr>
                    <td>#{{ p.id }}</td>
                    <td>
                      {% if p.provider == 'stripe' %}
                        <h6><span class="badge bg-dark-subtle text-dark-emphasis border">Stripe</span></h6>
                      {% elif p.provider == 'paypal' %}
                        <h6><span class="badge bg-primary-subtle text-primary-emphasis border">PayPal</span></h6>
                      {% else %}
                        <h6><span class="badge bg-secondary-subtle text-secondary-emphasis border">{{ p.provider|default:"Other" }}</span></h6>
                      {% endif %}
                    </td>
                    <td class="d-none d-md-table-cell">
                      <code class="text-muted">{{ p.gateway_ref|default:p.txn_id|default:"—" }}</code>
                    </td>
                    <td class="text-end">৳ {{ p.amount|floatformat:2|intcomma }}</td>
                    <td class="text-end">
                      {% if p.paid_on %}
                        {{ p.paid_on|date:"Y-m-d" }}
                      {% elif p.paid_at %}
                        {{ p.paid_at|date:"Y-m-d H:i" }}
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td class="text-end">
                      {% if p.receipts.exists and p.receipts.last.pdf %}
                        <a class="btn btn-sm btn-primary" href="{% url 'content:receipt-download' p.id %}">Download</a>
                      {% else %}
                        <span class="text-muted">Not ready</span>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% else %}
        <div class="invoice-card p-4">
          <p class="mb-0 text-muted">No payments yet.</p>
        </div>
      {% endif %}
    </div>
    {# ===================== END: My Payments (Receipts) ===================== #}

  </div>
</section>


{% endblock %}
